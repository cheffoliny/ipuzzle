<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="522" height="302" backgroundColor="#F2F2F2" borderStyle="solid" cornerRadius="7"
	creationComplete="init()" clipContent="true" horizontalScrollPolicy="off" verticalScrollPolicy="off">
	<mx:Script>
		<![CDATA[
			import mx.collections.SortField;
			import mx.collections.Sort;
			import mx.events.IndexChangedEvent;
			import flash.sampler.NewObjectSample;
			import mx.controls.listClasses.ListBase;
			import mx.formatters.NumberBase;
			import mx.events.FlexEvent;
			import mx.collections.ArrayCollection;
			import mx.managers.PopUpManager;
			
			public var closeAndAdd:Boolean = false;
			public var editMode:Boolean = false;
			[Bindable] public var firm_regions:ArrayCollection = new ArrayCollection();
			[Bindable] public var arr_services:ArrayCollection = new ArrayCollection();
			
			[Bindable] public var currDate:Date;
			public var service_id:int;
			public var service_name:String = "";
			public var office_id:int;
			
			public function get SinglePrice():Number {
				return getNumber(eEdCena.text);
			}
			private var sp:Number = 0;
			public function set SinglePrice(sp:Number):void {
				this.sp = sp;
			}
			
			public function getTotalSum():Number {
				return getNumber(lblSum.text);
			}

			private function init():void {
				firm_regionGroupByFirm.refresh();
				
				var dataSortField:SortField = new SortField();
                dataSortField.name = "name";
                var nameDataSort:Sort = new Sort();
                nameDataSort.fields = [dataSortField];
                arr_services.sort = nameDataSort;
				arr_services.refresh();
				
				accIndex = 0;
				arr_services.filterFunction = filterService;
               	arr_services.refresh();
               	if (arr_services.length == 1){
               		cbService.selectedIndex = 0;
               		changeService();
               	}

				if (editMode){
					setComboByValue(cbService, 'id_service', service_id);
					edService.text = service_name;
					eEdCena.text = currencyFormater.format(sp);
				} else {
					currDate = new Date();
				}
				calculate();
			}
			
			private function setComboByValue(cb:ComboBox, property:String, value:Object):void {
				if (cb.dataProvider == null)
					return;
				
				if (cb.dataProvider is Array){
					var a:Array = [];
					a = (cb.dataProvider as Array);
					if (a.length <= 0)
						return;
					for (var i:int = 0; i < a.length; i++){
						if (a[i][property] == value){
							cb.selectedIndex = i;
							return;
						}
					}
				}
				else if (cb.dataProvider is ArrayCollection){
					var ac:ArrayCollection = new ArrayCollection();
					ac = (cb.dataProvider as ArrayCollection);
					if (ac.length <= 0)
						return;
					for (var ic:int = 0; ic < ac.length; ic++){
						if (ac[ic][property] == value){
							cb.selectedIndex = ic;
							return;
						}
					}
				}				
			}
			
			private function getNumber(str:String):Number {
				var regEx:RegExp = /[,$]/g;
				var r:Number = parseFloat(str.replace(regEx,""));
				if (isNaN(r))
					r = 0;
				return r;
			}

			private function calculate(): void {
				lblSum.text = currencyFormater.format(getNumber(eEdCena.text) * nsKolich.value);
				validate();
			}

			private function getCurrentDate(currDate:Date):String {
				return monthFormatter.format(currDate);
			}
			private function firmregionCompare(a:Object, b:Object, fields:Array=null):int {
				if (a.fcode == b.fcode)
					return 0;
				return (a.fcode > b.fcode) ? 1 : -1;
			}
			
			public function addFirmData(event:FlexEvent):void {
				var selindx:int = lst.length-1;//accFirmRegion.selectedIndex;//event.target.owner.owner.owner.selectedIndex;
				if (selindx >= 0)
					event.target.dataProvider = firm_regionGroupByFirm.getRoot().getItemAt(selindx).children;
			}
			private function closeMe():void {
				PopUpManager.removePopUp(this);
				if (closeAndAdd){
					var lst:Object = accFirmRegion.selectedChild.getChildByName('lst');
					office_id = lst.selectedItem.rcode;
					service_id = cbService.selectedItem.id_service;
					service_name = edService.text;
				}
				dispatchEvent(new Event(Event.CLOSE));
			}
			
			private var accIndex:int = -1;
			private function changeAccordion(e:IndexChangedEvent):void {
				accIndex = e.newIndex;
				arr_services.filterFunction = filterService;
               	arr_services.refresh();
               	
               	edService.text = '';
				eEdCena.text = '';
				calculate();
			}
			private function filterService(item:Object):Boolean{
				var isMatch:Boolean = false;
               
				if (accFirmRegion.selectedChild == null)
					return false;
				var rep:Object = accFirmRegion.selectedChild.owner;
				if (rep == null)
					return false;
				if (rep.dataProvider == null)
					return false;
				var fcode:int = rep.dataProvider[accIndex].children[0].fcode;
				if(item.id_firm == fcode)
					isMatch = true;
               return isMatch;
           	}
			
			private function changeService():void {
				edService.text = cbService.selectedItem.name;
				eEdCena.text = cbService.selectedItem.price;
				calculate();
			}
			public function validate():void {
				var result:Boolean = true;
				var lst:Object = accFirmRegion.selectedChild.getChildByName('lst');
				result &&= (lst.selectedItem != null);
				result &&= (getNumber(eEdCena.text) != 0);
				result &&= (cbService.selectedIndex > -1);
				
				btnAdd.enabled = result;
			}
		]]>
	</mx:Script>

	<mx:DateFormatter id="monthFormatter" formatString="MMM YYYY г." />
	<mx:CurrencyFormatter id="currencyFormater" alignSymbol="right" currencySymbol="" rounding="nearest" precision="2" />

	<mx:GroupingCollection id="firm_regionGroupByFirm" source="{firm_regions}">
    	<mx:grouping>
    		<mx:Grouping compareFunction="firmregionCompare">
    			<mx:GroupingField name="firm"/> 
    		</mx:Grouping>
    	</mx:grouping>
    </mx:GroupingCollection>

	<mx:Label x="10" y="10" text="Фирма - Регион"/>
	<mx:Label x="221" y="34" text="Услуга:"/>
	<mx:Label x="221" y="71" text="Наименование:"/>
	<mx:Label x="221" y="106" text="Ед. цена:"/>
	<mx:Label x="221" y="161" text="Количество:"/>
	<mx:Label x="221" y="194" text="Сума:"/>
	<mx:Label x="221" y="226" text="Дата:"/>
	<mx:Accordion x="10" y="30" width="200" height="260" styleName="edAcc" id="accFirmRegion"
		change="{changeAccordion(event)}">
		<mx:Repeater id="accRepeater" dataProvider="{firm_regionGroupByFirm.getRoot()}">
			<mx:Canvas id="canv" label="{accRepeater.currentItem.GroupLabel}" width="100%" height="100%" backgroundAlpha="100"
				horizontalScrollPolicy="off" verticalScrollPolicy="off">
				<mx:List id="lst" x="0" y="0" width="100%" height="99%" textAlign="left"
					showDataTips="true" dataTipField="region"
					borderThickness="0"
					verticalScrollPolicy="{lst.length > 1 ? 'auto' : 'off'}"
					labelField="region"
					initialize="{addFirmData(event)}"
					/>
			</mx:Canvas>
		</mx:Repeater>
	</mx:Accordion>
	<mx:ComboBox id="cbService" x="318" y="32" width="170" dataProvider="{arr_services}" labelField="name" selectedIndex="-1"
		change="{changeService()}">
		<mx:itemRenderer>
			<mx:Component>
				<mx:Canvas horizontalScrollPolicy="off">
				<mx:Label left="2" right="2" text="{data.name}"
					toolTip="{data.name}"
					fontWeight="{(data.id_service &lt; 0) ? 'bold' : 'normal'}"
					color="{(data.id_service &lt; 0) ? 0xFF5555 : 0}"/>
				</mx:Canvas>
			</mx:Component>
		</mx:itemRenderer>
	</mx:ComboBox>
	<mx:TextInput x="318" y="104" width="170" textAlign="right" restrict="0-9.\-" id="eEdCena" change="calculate()"/>
	<mx:TextInput x="318" y="69" width="170" id="edService"/>

	<mx:Label x="470" y="194" text="лв."/>
	<mx:Label x="318" y="194" text="0.00" width="153" textAlign="right" fontWeight="bold" id="lblSum"/>
	
	<mx:Canvas x="318" y="225" width="170" height="22">
		<mx:Label id="lblDate" text="{getCurrentDate(currDate)}" verticalCenter="-3" horizontalCenter="2" textAlign="center"/>
		<mx:LinkButton width="45" left="0" icon="@Embed(source='001_23.png')"
			click="{currDate['month'] = currDate['month'] - 1;lblDate.text=getCurrentDate(currDate)}" verticalCenter="-3"/>
		<mx:LinkButton width="45" icon="@Embed(source='001_21.png')"
			click="{currDate['month'] = currDate['month'] + 1;lblDate.text=getCurrentDate(currDate)}" verticalCenter="-3" right="0"/>
	</mx:Canvas>
	<mx:Canvas width="250" height="60" left="318" top="262" styleName="extension" borderStyle="solid" cornerRadius="7">
		<mx:Button label="Затвори" click="{closeMe()}" fillAlphas="[0.3, 0.3, 1.0, 1.0]" fillColors="[#FBD2D2, #F59393]" top="7" right="55" width="85"/>
		<mx:Button id="btnAdd" label="Добави" fillAlphas="[0.3, 0.3, 1.0, 1.0]" fillColors="[#CBEACB, #77D877]" width="85" click="{closeAndAdd=true;closeMe()}" top="7" left="7" />
	</mx:Canvas>
	<mx:NumericStepper x="318" y="159" width="170" textAlign="right" minimum="1" stepSize="1" id="nsKolich" change="calculate()" maximum="999999999" keyUp="calculate()"/>
	<mx:Label x="274" y="99" text="*" textAlign="center" fontWeight="bold" fontSize="17" fontFamily="Verdana" color="#FF6A47" height="20" width="20"/>
	<mx:Label x="319" y="125" text="*" textAlign="center" fontWeight="bold" fontSize="17" fontFamily="Verdana" color="#FF6A47" height="20" width="20"/>
	<mx:Label x="340" y="127" text="Сумите са БЕЗ ДДС !" width="148" color="#FF6A47" fontWeight="bold"/>

</mx:Canvas>
